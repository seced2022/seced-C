<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SECeD - Escoba</title>
  <link rel="stylesheet" href="styles.css" />
  <meta name="theme-color" content="#0b1f12" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root{
      --bg:#0b1f12;
      --panel:#0f1a14;
      --panel-border:#1d2d23;
      --text:#eafff7;
      --accent:#22c55e;
    }
    body{ background:var(--bg); color:var(--text); }
    .app{ max-width:1280px; margin:0 auto; padding:16px; }

    .brand{ display:flex; align-items:center; gap:12px; }
    .brand-logo{ height:42px; }

    .header-row{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      margin:10px 0 16px;
    }

    /* Reloj: HH:MM:SS (sin ms) */
    .clock {
      display:flex; align-items:baseline; gap:10px;
      font-variant-numeric: tabular-nums;
      font-weight:900;
      letter-spacing:.5px;
      font-size:28px;
    }

    .tc-buttons{
      display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;
    }
    .btn-tramo{
      background:#0c2415; border:1px solid #13301e; color:#eafff7;
      padding:8px 12px; border-radius:10px; font-weight:800; cursor:pointer;
    }
    .btn-tramo.active{ background:#115e38; border-color:#1aa165; }

    .panel{
      background:var(--panel);
      border:1px solid var(--panel-border);
      border-radius:14px;
      padding:14px;
    }

    /* Línea horizontal de abandonos */
    .aband-row{
      display:flex; gap:10px; flex-wrap:nowrap; overflow-x:auto; padding-bottom:6px;
    }
    .aband-card{
      background:#3b0f10; border:1px solid #6b181a; color:#fff; min-width:90px;
      border-radius:10px; padding:8px 10px; text-align:center; font-weight:900;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.08);
      white-space:nowrap;
    }
    .aband-card .r{ font-size:12px; opacity:.85; font-weight:700; }

    /* Mapa */
    #mapEscoba { width:100%; height:460px; border-radius:10px; border:1px solid var(--panel-border); }

    /* Placa de radio (debajo de las bolitas) */
    .radio-badge {
      background:#333;
      border:2px solid #666;
      border-radius:20px;
      color:#fff;
      font-weight:900;
      text-align:center;
      min-width:70px;
      padding:2px 8px;
      font-size:13px;
      box-shadow:0 6px 16px rgba(0,0,0,.35);
      user-select:none;
    }

    /* “Pile” de bolitas pequeñas (dorsales) */
    .pile{
      display:flex; gap:5px; flex-wrap:wrap;
      align-items:center;
      padding:4px 6px;
      background:#0d2618;
      border:1px solid #16422a;
      border-radius:12px;
      box-shadow:0 6px 16px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.06);
    }
    .pill{
      display:inline-flex; align-items:center; justify-content:center;
      width:18px; height:18px;
      border-radius:9999px;
      background:#ef4444;
      border:1px solid #b91c1c;
      font-size:11px; font-weight:900; color:#fff;
      line-height:1;
      user-select:none;
    }

    .row-gap{ height:12px; }
  </style>
</head>
<body>
  <main class="app">
    <div class="brand">
      <img id="logo" src="logo.svg" class="brand-logo" onerror="this.src='logo.png'"/>
      <h1 id="title">SECeD — Escoba</h1>
    </div>

    <div class="header-row">
      <div class="clock"><span id="hhmmss">--:--:--</span></div>
      <div class="tc-buttons" id="tcButtons"></div>
    </div>

    <div class="panel" id="panelEscoba">
      <div id="abandRow" class="aband-row" aria-live="polite"></div>
      <div class="row-gap"></div>
      <div id="mapEscoba"></div>
    </div>
  </main>

  <!-- Firebase + Leaflet -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // ===== Estado base =====
    let db;
    let rallyId = new URLSearchParams(location.search).get('id');
    let configGlobal = null;
    let tramoActivo = null; // nombre visible exacto del tramo
    let map = null;
    let overlayLayerGroup = null;

    // ===== Reloj (HH:MM:SS) =====
    let timeOffsetMs = 0, tickTimer = null, resyncTimer = null;
    const pad2 = n => String(n).padStart(2,'0');
    function renderClock(){
      const now = new Date(Date.now() + timeOffsetMs);
      const hh = pad2(now.getHours());
      const mm = pad2(now.getMinutes());
      const ss = pad2(now.getSeconds());
      const elH = document.getElementById('hhmmss');
      if (elH) elH.textContent = `${hh}:${mm}:${ss}`;
    }
    async function syncTime(){
      try{
        const res = await fetch('https://worldtimeapi.org/api/timezone/Europe/Madrid',{cache:'no-store'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        const json = await res.json();
        const api = Date.parse(json.datetime);
        timeOffsetMs = api - Date.now();
      }catch(e){
        timeOffsetMs = 0; // no bloquea UI si falla
      }
    }
    function startClock(){
      clearInterval(tickTimer);
      tickTimer = setInterval(renderClock, 1000);
      renderClock();
      clearInterval(resyncTimer);
      resyncTimer = setInterval(syncTime, 5*60*1000);
    }

    // ===== Leaflet helpers =====
    function buildMapIfNeeded(){
      if (map) return;
      map = L.map('mapEscoba').setView([37.88, -4.77], 12);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

      // panes para controlar superposición (no afecta a datos)
      map.createPane('radiosPane');  map.getPane('radiosPane').style.zIndex = 400;
      map.createPane('abandPane');   map.getPane('abandPane').style.zIndex = 450;

      overlayLayerGroup = L.layerGroup().addTo(map);
    }
    function clearMap(){
      if (!overlayLayerGroup) return;
      overlayLayerGroup.clearLayers();
    }
    function drawTrackAndRadios(tramoCfg){
      if (!tramoCfg) return;
      clearMap();

      // track como polilínea si viene como array de [lat,lng]
      if (Array.isArray(tramoCfg.track) && tramoCfg.track.length){
        const poly = L.polyline(tramoCfg.track, { color: '#22c55e', weight: 4 }).addTo(overlayLayerGroup);
        try { map.fitBounds(poly.getBounds(), { padding:[20,20] }); } catch {}
      } else if (Array.isArray(tramoCfg.center) && tramoCfg.center.length===2) {
        try { map.setView(tramoCfg.center, tramoCfg.zoom || 12); } catch {}
      }

      if (Array.isArray(tramoCfg.radios)) {
        tramoCfg.radios.forEach((r, idx)=>{
          const nR = idx + 1;
          const icon = L.divIcon({
            className: 'custom-icon',
            html: `<div class="radio-badge">R${nR}</div>`,
            iconSize: [1,1], iconAnchor: [0,0]
          });
          L.marker([r.lat, r.lng], { icon, pane:'radiosPane' }).addTo(overlayLayerGroup);
        });
      }
    }

    // ===== Línea horizontal de abandonos (cajas rojas) =====
    function renderAbandCards(docData){
      const row = document.getElementById('abandRow');
      if (!row) return;
      row.innerHTML = '';

      // docData: { radio1:[d1,d2], radio2:[...], ... }
      const entries = [];
      Object.keys(docData || {}).forEach(k=>{
        if (!k.startsWith('radio')) return;
        const n = Number(k.replace('radio',''));
        const arr = Array.isArray(docData[k]) ? docData[k] : [];
        arr.forEach(d => entries.push({ dorsal:d, radio:n }));
      });

      // Orden simple por dorsal asc (igual que antes)
      entries.sort((a,b)=> a.dorsal - b.dorsal);

      for (const it of entries){
        const card = document.createElement('div');
        card.className = 'aband-card';
        card.innerHTML = `<div>${it.dorsal}</div><div class="r">R${it.radio}</div>`;
        row.appendChild(card);
      }
    }

    // ===== Bolitas pequeñas en el mapa (dorsales abandonados) =====
    function renderAbandDotsOnMap(tramoCfg, docData){
      if (!tramoCfg || !Array.isArray(tramoCfg.radios)) return;

      // Agrupamos por radio
      const groups = new Map();
      Object.keys(docData || {}).forEach(k=>{
        if (!k.startsWith('radio')) return;
        const n = Number(k.replace('radio',''));
        const arr = Array.isArray(docData[k]) ? docData[k] : [];
        groups.set(n, arr.slice());
      });

      // offset suave por radio (para no montar sobre la placa)
      const baseOffsets = [
        { lat:  0.00022, lng:  0.00000 },
        { lat:  0.00018, lng:  0.00018 },
        { lat:  0.00000, lng:  0.00022 },
        { lat: -0.00018, lng:  0.00018 },
        { lat: -0.00022, lng:  0.00000 },
        { lat: -0.00018, lng: -0.00018 },
        { lat:  0.00000, lng: -0.00022 },
        { lat:  0.00018, lng: -0.00018 },
      ];

      tramoCfg.radios.forEach((r, idx)=>{
        const nR = idx + 1;
        const dorsales = groups.get(nR) || [];
        if (dorsales.length === 0) return;

        const html = `
          <div class="pile">
            ${dorsales.slice(0, 120).map(d => `<span class="pill" title="Dorsal ${d}">${d}</span>`).join('')}
          </div>
        `;
        const off = baseOffsets[idx % baseOffsets.length];
        const icon = L.divIcon({
          className:'custom-icon',
          html,
          iconSize:[1,1],
          iconAnchor:[0,0]
        });
        L.marker([r.lat + off.lat, r.lng + off.lng], { icon, pane:'abandPane' })
          .addTo(overlayLayerGroup);
      });
    }

    // ===== Suscripciones =====
    let unsubAband = null;
    function subscribeAbandonos(nombreTramo, tramoCfg){
      if (unsubAband) { try { unsubAband(); } catch {} unsubAband = null; }

      unsubAband = db.collection('rallies').doc(rallyId)
        .collection('abandono_tramos').doc(nombreTramo)
        .onSnapshot(snap=>{
          const data = snap.exists ? (snap.data()||{}) : {};
          renderAbandCards(data);
          drawTrackAndRadios(tramoCfg);
          renderAbandDotsOnMap(tramoCfg, data);
        }, err => console.warn('abandono_tramos listener error', err));
    }

    // ===== Botones de tramo =====
    function renderTramoButtons(){
      const box = document.getElementById('tcButtons');
      box.innerHTML = '';
      (configGlobal.tramos || []).forEach((tr)=>{
        const btn = document.createElement('button');
        btn.className = 'btn-tramo' + (tramoActivo === tr.nombre ? ' active' : '');
        btn.textContent = tr.nombre;
        btn.addEventListener('click', ()=>{
          tramoActivo = tr.nombre;
          document.querySelectorAll('.btn-tramo').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          buildMapIfNeeded();
          subscribeAbandonos(tramoActivo, tr);
        });
        box.appendChild(btn);
      });
    }

    // ===== Init =====
    async function init(){
      // Firebase
      if (typeof window.FIREBASE_CONFIG === 'undefined') {
        alert("ERROR: No se encuentra 'firebase-config.js'.");
        return;
      }
      if (!firebase.apps.length) firebase.initializeApp(window.FIREBASE_CONFIG);
      db = firebase.firestore();

      // Reloj (igual que antes pero sólo HH:MM:SS)
      await syncTime();
      startClock();

      // ID de rally
      if (!rallyId) {
        rallyId = prompt("Introduce el ID del Rally:");
        if (!rallyId) return;
        const p = new URLSearchParams(location.search);
        p.set('id', rallyId);
        window.history.replaceState({}, '', `${location.pathname}?${p.toString()}`);
      }

      // Config del rally (logo, nombre, tramos)
      const cfg = await db.collection('config_rallies').doc(rallyId).get();
      if (!cfg.exists) {
        alert('El ID de rally no existe en config_rallies.');
        return;
      }
      configGlobal = cfg.data() || {};
      if (configGlobal.logo) document.getElementById('logo').src = configGlobal.logo;
      if (configGlobal.nombre) document.getElementById('title').textContent = `${configGlobal.nombre} — Escoba`;

      // Construir botones de tramo (selección manual como antes)
      renderTramoButtons();

      // No auto-activamos tramo: se mantiene la interacción “como antes”
      // (Si quisieras auto-activar el primero: descomenta abajo)
      /*
      if (Array.isArray(configGlobal.tramos) && configGlobal.tramos.length) {
        tramoActivo = configGlobal.tramos[0].nombre;
        const firstBtn = document.querySelector('.btn-tramo');
        if (firstBtn) firstBtn.classList.add('active');
        buildMapIfNeeded();
        subscribeAbandonos(tramoActivo, configGlobal.tramos[0]);
      }
      */
    }

    window.addEventListener('load', init);
  </script>
</body>
</html>
