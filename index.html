<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SECeD - Control</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="icon" href="favicon.png" type="image/png">
  <link rel="apple-touch-icon" href="favicon.png">
  <meta name="theme-color" content="#0b1f12">
  <style>
    /* Estilos para el bloqueo de Salida Parada */
    .alerta-dc-control {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(127, 29, 29, 0.98); color: white; z-index: 10000;
      display: flex; flex-direction: column; justify-content: center;
      align-items: center; text-align: center; font-family: sans-serif;
      animation: pulse-bg 2s infinite;
    }
    @keyframes pulse-bg {
      0% { background: rgba(127, 29, 29, 0.98); }
      50% { background: rgba(185, 28, 28, 0.98); }
      100% { background: rgba(127, 29, 29, 0.98); }
    }
    .alerta-dc-control h1 { font-size: 4rem; margin: 0; font-weight: 900; text-shadow: 0 4px 10px rgba(0,0,0,0.5); }
    .alerta-dc-control p { font-size: 1.5rem; margin-top: 10px; }
    .alerta-dc-control .tramo-box { margin-top: 20px; border: 3px solid white; padding: 10px 30px; font-weight: bold; text-transform: uppercase; font-size: 1.8rem; }
  </style>
</head>
<body>
  <main class="app" aria-label="Aplicaci√≥n de tarjetas num√©ricas">
    <div class="brand">
      <img src="logo.svg" alt="SECeD" class="brand-logo" id="mainLogo" onerror="this.src='logo.png'"/>
    </div>
    <h1 id="mainTitle">SECeD - Control</h1>

    <div class="clock-bar">
      <div class="clock">
        <span id="clockTime">--:--:--</span>
        <span class="tz" id="clockTz">Europe/Madrid</span>
        <span class="sync" id="clockSync" title="Estado de sincronizaci√≥n">sincronizando‚Ä¶</span>
      </div>

      <div class="controls-right">
        <div class="tramo-picker">
          <button id="btnTramo" type="button" class="secondary">TRAMO ‚ñæ</button>
          <div id="tramoMenu" class="tramo-menu hidden" role="menu" aria-label="Seleccionar tramo">
            <div class="tm-section">
              <label for="tramoInput">Escribir tramo</label>
              <input id="tramoInput" type="text" placeholder="ej. tramo-1" />
              <button id="tramoGo" type="button" class="primary">Ir</button>
            </div>
            <div class="tm-section">
              <div class="tm-label">Recientes</div>
              <ul id="tramoRecent"></ul>
            </div>
          </div>
        </div>

        <div class="mode-panel">
          <button id="btnModeJefe"   type="button" class="mode-btn mode-jefe"   title="JEFE DE TRAMO: permite todo">ADJUNTO DE TRAMO</button>
          <button id="btnModeSalida" type="button" class="mode-btn mode-salida" title="SALIDA: solo altas">SALIDA</button>
          <button id="btnModeLlegada"type="button" class="mode-btn mode-llegada" title="LLEGADA: solo LL/Abandono">LLEGADA</button>
        </div>

        <div class="micro-panel">
          <button id="btnOperador" class="micro-btn" title="Identificarse como operador">üë§</button>
          <button id="btnAudit" class="micro-btn" title="Abrir auditor√≠a (clave requerida)">üõ°Ô∏è</button>
        </div>
      </div>
    </div>

    <div class="row">
      <input id="inputNumero" type="number" inputmode="numeric" placeholder="Escribe un n√∫mero" />
      <button id="btnAgregar" type="button">Agregar</button>
    </div>

    <p class="help"></p>
    <div class="toolbar"></div>
    <section id="grid" class="grid" aria-live="polite"></section>

    <div class="export-bar">
      <button id="btnResetRadios" type="button" class="btn btn-warn" style="display:none">Reset dorsales</button>
      <button id="btnLimpiar" class="secondary">Limpiar</button>
      <button id="btnExportar" type="button" class="primary">Exportar a PDF</button>
      <button id="btnFullscreen" type="button" class="secondary btn-fullscreen" title="Pantalla completa">Pantalla completa</button>
      <div class="counters">
        <div class="counter" title="Total de recuadros"><span class="label">Salida</span><span id="countSalida">0</span></div>
        <div class="counter" title="Marcados en verde"><span class="label">LLegada</span><span id="countLlegada">0</span></div>
        <div class="counter" title="En abandono (rojo)"><span class="label">Abandonos</span><span id="countAbandonos">0</span></div>
      </div>
    </div>

    <div id="printTitle" class="print-title" aria-hidden="true"></div>
    <div id="printCounters" class="print-counters" aria-hidden="true"></div>

    <div id="auditPanel" class="audit hidden" role="dialog" aria-modal="true" aria-label="Panel de auditor√≠a">
      <div class="audit-head">
        <strong>Auditor√≠a</strong>
        <div class="audit-tools">
          <button id="btnAuditRefresh" class="secondary">Actualizar</button>
          <button id="btnAuditCSV" class="secondary">Exportar auditor√≠a (CSV)</button>
          <button id="btnStatesCSV" class="secondary">Exportar estados (CSV)</button>
          <button id="btnAuditClose">Cerrar ‚úï</button>
        </div>
      </div>
      <div id="auditList" class="audit-list"></div>
    </div>
  </main>

  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js?v=2"></script>

  <script>
    if (!firebase.apps.length) firebase.initializeApp(window.FIREBASE_CONFIG);
    const db = firebase.firestore();
    const urlParams = new URLSearchParams(window.location.search);
    let rallyId = urlParams.get('id');
    const TRAMO_ID_NUM = urlParams.get('tramo') || '1';
    
    let audioCtx = null;
    let alarmInterval = null;

    // Funci√≥n para generar sonido de alerta (Sirena)
    function playAlarmSound() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(440, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(880, audioCtx.currentTime + 0.5);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.5);
    }

    if (rallyId) {
        db.collection("config_rallies").doc(rallyId).get().then(doc => {
            if (doc.exists) {
                const data = doc.data();
                if (data.logo) document.getElementById('mainLogo').src = data.logo;
                if (data.nombre) document.querySelector('h1').innerText = data.nombre;
                
                const idx = parseInt(TRAMO_ID_NUM) - 1;
                if (data.tramos && data.tramos[idx]) {
                    activarEscuchaDC(data.tramos[idx].nombre);
                }
            }
        });
    }

    function activarEscuchaDC(nombreTramo) {
        db.collection("rallies").doc(rallyId).collection("estado_tramos").doc(nombreTramo).onSnapshot(doc => {
            const esAdjunto = document.getElementById('btnModeJefe').classList.contains('active');
            const esSalida = document.getElementById('btnModeSalida').classList.contains('active');
            let aviso = document.getElementById('aviso-parada-dc');

            if (doc.exists && doc.data().pararSalida && (esAdjunto || esSalida)) {
                if (!aviso) {
                    aviso = document.createElement('div');
                    aviso.id = 'aviso-parada-dc';
                    aviso.className = 'alerta-dc-control';
                    aviso.innerHTML = `<h1>‚ö†Ô∏è SALIDA PARADA</h1><p>ORDEN DE DIRECCI√ìN DE CARRERA</p><div class="tramo-box">${nombreTramo}</div>`;
                    document.body.appendChild(aviso);
                    // Iniciar sonido intermitente
                    if (!alarmInterval) alarmInterval = setInterval(playAlarmSound, 1000);
                }
            } else {
                if (aviso) aviso.remove();
                if (alarmInterval) { clearInterval(alarmInterval); alarmInterval = null; }
            }
        });
    }
  </script>

  <script src="alerts-listener.js"></script>  
  <script src="sync.js?v=2"></script>
  <script src="app.js?v=2"></script>
</body>
</html>
