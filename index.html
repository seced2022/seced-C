<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SECeD - Control</title>
  <link rel="stylesheet" href="styles.css?v=41" />
  <meta name="theme-color" content="#0b1f12" />
</head>
<body>
  <main class="app">
    <div class="brand">
      <img src="logo.svg" alt="SECeD" class="brand-logo" onerror="this.src='logo.png'"/>
    </div>

    <h1>SECeD - Control</h1>

    <div class="clock-bar">
      <div class="clock">
        <span id="clockTime">--:--:--</span>
        <span class="tz" id="clockTz">Europe/Madrid</span>
        <span class="sync" id="clockSync">sincronizandoâ€¦</span>
      </div>

      <div class="controls-right">
        <div class="tramo-picker">
          <button id="btnTramo" type="button" class="secondary">TRAMO â–¾</button>
          <div id="tramoMenu" class="tramo-menu hidden" role="menu">
            <div class="tm-section">
              <label for="tramoInput">Escribir tramo</label>
              <input id="tramoInput" type="text" placeholder="ej. tramo-1" />
              <button id="tramoGo" type="button" class="primary">Ir</button>
            </div>
            <div class="tm-section">
              <div class="tm-label">Recientes</div>
              <ul id="tramoRecent"></ul>
            </div>
          </div>
        </div>

        <div class="micro-panel">
          <button id="btnModeJefe"   class="micro-btn" title="Jefe de Tramo">Jefe</button>
          <button id="btnModeSalida" class="micro-btn" title="Salida">Salida</button>
          <button id="btnModeLlegada"class="micro-btn" title="Llegada">Llegada</button>
          <button id="btnOperador"   class="micro-btn" title="Cambiar usuario">ðŸ‘¤</button>
        </div>
      </div>
    </div>

    <section class="controls">
      <div class="input-group">
        <input id="inputNumero" type="text" inputmode="numeric" placeholder="Dorsalâ€¦" />
        <button id="btnAgregar" class="primary">AÃ±adir</button>
        <button id="btnLimpiar" class="secondary">Vaciar</button>
        <button id="btnResetRadios" class="danger" style="display:none;">Reset radios</button>
      </div>
      <div class="counters">
        <div>Salida: <span id="countSalida">0</span></div>
        <div>Llegada: <span id="countLlegada">0</span></div>
        <div>Abandonos: <span id="countAbandonos">0</span></div>
      </div>
    </section>

    <section id="grid" class="grid" aria-live="polite"></section>

    <!-- AuditorÃ­a -->
    <section id="auditPanel" class="audit hidden" aria-hidden="true">
      <header>
        <h2>AuditorÃ­a</h2>
        <div>Tramo: <span id="auditTramo">â€”</span> Â· Operador: <span id="auditOperador">â€”</span></div>
        <div class="audit-actions">
          <button id="btnAuditRefresh" class="secondary">Refrescar</button>
          <button id="btnAuditCSV" class="secondary">CSV</button>
          <button id="btnStatesCSV" class="secondary">Estados CSV</button>
          <button id="btnAuditClose" class="danger">Cerrar</button>
        </div>
      </header>
      <div id="auditList" class="audit-list"></div>
    </section>

    <button id="btnAudit" class="floating">AuditorÃ­a</button>
    <button id="btnExportar" class="floating secondary">Exportar PDF</button>
    <h2 id="printTitle" class="hidden"></h2>
    <div id="printCounters" class="hidden"></div>
  </main>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js?v=16"></script>

  <!-- Reloj en lÃ­nea (igual que usas en otras pÃ¡ginas) -->
  <script>
    (function(){
      const TIMEZONE = 'Europe/Madrid';
      const clockTime = document.getElementById('clockTime');
      const clockTz = document.getElementById('clockTz');
      const clockSync = document.getElementById('clockSync');
      if (clockTz) clockTz.textContent = TIMEZONE;
      let timeOffsetMs = 0, tickTimer = null, resyncTimer = null;
      const pad = n => String(n).padStart(2,'0');
      const renderClock = () => {
        const d = new Date(Date.now() + timeOffsetMs);
        if (clockTime) clockTime.textContent = `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
      };
      const syncTime = async () => {
        try {
          if (clockSync) { clockSync.textContent = 'sincronizandoâ€¦'; clockSync.className = 'sync'; }
          const res = await fetch(`https://worldtimeapi.org/api/timezone/${encodeURIComponent(TIMEZONE)}`, { cache: 'no-store' });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const data = await res.json();
          const apiMs = Date.parse(data.datetime);
          timeOffsetMs = apiMs - Date.now();
          if (clockSync) { clockSync.textContent = 'ok'; clockSync.className = 'sync ok'; }
        } catch {
          if (clockSync) { clockSync.textContent = 'sin conexiÃ³n'; clockSync.className = 'sync err'; }
        }
      };
      const startClock = () => {
        clearInterval(tickTimer); tickTimer = setInterval(renderClock, 1000); renderClock();
        clearInterval(resyncTimer); resyncTimer = setInterval(syncTime, 5*60*1000);
      };
      syncTime().then(startClock);
    })();
  </script>

  <!-- Tu lÃ³gica principal -->
  <script src="sync.js?v=16"></script>
  <script src="app.js?v=16"></script>

  <!-- Helpers de banner PARADA/REANUDADA para Control -->
  <script>
    function ensureStopBannerEditor() {
      let b = document.getElementById('stopBannerEditor');
      if (!b) {
        b = document.createElement('div');
        b.id = 'stopBannerEditor';
        Object.assign(b.style, {
          position:'fixed', top:'12px', left:'50%', transform:'translateX(-50%)',
          zIndex:2000, padding:'14px 18px', borderRadius:'12px', fontWeight:'900',
          fontSize:'16px', boxShadow:'0 10px 24px rgba(0,0,0,.45)', display:'none'
        });
        document.body.appendChild(b);
      }
      return b;
    }
    function showStopBannerRedEditor(msg='SALIDA PARADA') {
      const b = ensureStopBannerEditor();
      b.textContent = msg;
      b.style.background = '#b91c1c';
      b.style.color = '#fff';
      b.style.border = '2px solid #7f1d1d';
      b.style.display = 'flex';
    }
    function flashGreenResumeEditor(msg='SALIDA REANUDADA') {
      const b = ensureStopBannerEditor();
      b.textContent = msg;
      b.style.background = '#15803d';
      b.style.color = '#fff';
      b.style.border = '2px solid #16a34a';
      b.style.display = 'flex';
      clearTimeout(b._hide);
      b._hide = setTimeout(()=>{ b.style.display='none'; }, 2500);
    }
    function hideStopBannerEditor() {
      const b = ensureStopBannerEditor();
      b.style.display = 'none';
    }
  </script>

  <!-- SuscripciÃ³n al estado de parada desde DC (solo Control) -->
  <script>
    (function(){
      try{
        if (!window.firebase || !firebase.firestore) return;
        const db = firebase.firestore();

        // Lee ?id= (rally) y tramo (igual que usÃ¡is en Panel/Editor)
        const rallyId = new URLSearchParams(location.search).get('id') || '';
        if (!rallyId) return; // si no hay rally, no escuchamos (no rompemos nada)

        const tramoNombre = (window.TRAMO_ID || new URLSearchParams(location.search).get('tramo') || '1').toString();

        const ref = db.collection('rallies').doc(rallyId)
                      .collection('estado_tramos').doc(tramoNombre);

        let lastStopped = null;
        ref.onSnapshot(snap => {
          const stopped = snap.exists && snap.data() && (snap.data().pararSalida === true);

          // Mostrar solo en modos JEFE o SALIDA
          const showInThisMode = (window.MODE === 'JEFE' || window.MODE === 'SALIDA');

          if (stopped) {
            if (showInThisMode) showStopBannerRedEditor('SALIDA PARADA');
            else hideStopBannerEditor();
          } else {
            if (lastStopped === true) {
              if (showInThisMode) flashGreenResumeEditor('SALIDA REANUDADA');
              else hideStopBannerEditor();
            } else {
              hideStopBannerEditor();
            }
          }
          lastStopped = stopped;
        }, err => console.warn('estado_tramos (control) listener error', err));
      } catch(e){
        console.warn('subscribeStopFromDC (control) error', e);
      }
    })();
  </script>
</body>
</html>
