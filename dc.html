<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>SECeD 路 Panel DC Din谩mico</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root { 
            --bg:#0b120e; 
            --card:#0f1a14; 
            --border:#1d2d23; 
            --danger:#b91c1c; 
            --text:#e6f2ea; 
            --accent:#17a34a; 
        }
        body { 
            margin:0; 
            background:var(--bg); 
            color:var(--text); 
            font-family: sans-serif; 
            overflow: hidden; 
        }
        .topbar { 
            padding:10px 20px; 
            background:#0c1913; 
            border-bottom:1px solid var(--border); 
            display:flex; 
            justify-content:space-between; 
            align-items:center; 
            height: 60px; 
            box-sizing: border-box; 
        }
        .brand-logo { height: 40px; margin-right: 15px; }
        .content { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 15px; 
            padding: 15px; 
            height: calc(100vh - 60px); 
            box-sizing: border-box; 
            overflow-y: auto;
        }
        .tramo-card { 
            background:var(--card); 
            border:1px solid var(--border); 
            border-radius:12px; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            min-height: 400px;
        }
        .map-header { 
            padding:12px; 
            font-weight:bold; 
            text-align:center; 
            background: #111e17; 
            border-bottom: 1px solid var(--border); 
        }
        .map-wrap { 
            flex-grow: 1; 
            background:#111; 
            width:100%; 
        }
        .btn-stop { 
            width:100%; 
            padding:15px; 
            background:var(--danger); 
            color:white; 
            border:none; 
            font-size:1.1rem; 
            font-weight:bold; 
            cursor:pointer; 
        }
        #reloj { 
            font-size:1.5rem; 
            font-weight:bold; 
            color:var(--accent); 
            font-family: monospace; 
        }
        .loading-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: var(--bg); display: flex; justify-content: center;
            align-items: center; z-index: 9999; font-size: 1.5rem;
        }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="loading" class="loading-overlay">Cargando configuraci贸n del Rally...</div>

<header class="topbar">
    <div style="display:flex; align-items:center;">
        <img src="logo.svg" alt="Logo" class="brand-logo" id="rallyLogo" onerror="this.src='logo.png'">
        <div style="font-size: 1.2rem; font-weight: bold;">SECeD 路 <span id="rallyNombre" style="color:var(--accent)">CARGANDO...</span></div>
    </div>
    <div id="reloj">00:00:00</div>
</header>

<main id="gridTramos" class="content">
    </main>

<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>

<script>
    const db = firebase.firestore();
    const urlParams = new URLSearchParams(window.location.search);
    const rallyId = urlParams.get('id'); // Ejemplo: dc.html?id=sierra-morena-25

    // 1. Reloj en tiempo real
    setInterval(() => { 
        document.getElementById('reloj').innerText = new Date().toLocaleTimeString(); 
    }, 1000);

    // 2. Cargar datos desde Firebase
    if (rallyId) {
        db.collection("config_rallies").doc(rallyId).onSnapshot(doc => {
            if (doc.exists) {
                const data = doc.data();
                document.getElementById('loading').classList.add('hidden');
                inicializarPanel(data);
            } else {
                document.getElementById('loading').innerText = "Error: ID de Rally no encontrado.";
            }
        }, error => {
            console.error("Error Firebase:", error);
            document.getElementById('loading').innerText = "Error de conexi贸n con la base de datos.";
        });
    } else {
        document.getElementById('loading').innerHTML = "Falta el ID del rally en la URL.<br>Usa: dc.html?id=TU_ID";
    }

    function inicializarPanel(rally) {
        // Actualizar Cabecera
        if(rally.nombre) document.getElementById('rallyNombre').innerText = rally.nombre.toUpperCase();
        if(rally.logo) document.getElementById('rallyLogo').src = rally.logo;

        const container = document.getElementById('gridTramos');
        container.innerHTML = ''; // Limpiar para recargar si hay cambios

        rally.tramos.forEach((tramo, index) => {
            const mapId = `map_tc_${index}`;
            
            // Crear Card del Tramo
            const card = document.createElement('div');
            card.className = 'tramo-card';
            card.innerHTML = `
                <div class="map-header">${tramo.nombre}</div>
                <div id="${mapId}" class="map-wrap"></div>
                <button class="btn-stop" onclick="alert('Salida de ${tramo.nombre} PARADA')"> PARAR SALIDA</button>
            `;
            container.appendChild(card);

            // Inicializar Mapa de Leaflet
            setTimeout(() => {
                const centro = (tramo.track && tramo.track.length > 0) ? tramo.track[0] : [38.4, -4.8];
                const map = L.map(mapId).setView(centro, 12);
                
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; SECeD Control'
                }).addTo(map);

                if (tramo.track && tramo.track.length > 0) {
                    const poly = L.polyline(tramo.track, {
                        color: '#2ecc71',
                        weight: 5,
                        opacity: 0.8,
                        lineJoin: 'round'
                    }).addTo(map);

                    // Ajuste autom谩tico del zoom para que se vea todo el track
                    map.fitBounds(poly.getBounds(), { padding: [30, 30] });
                }
                
                // Forzar refresco de tama帽o por si el grid movi贸 el div
                map.invalidateSize();
            }, 100);
        });
    }
</script>
</body>
</html>
