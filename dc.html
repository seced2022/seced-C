<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SECeD - Dirección de Carrera</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root { --panel-bg: #0b120e; --header-h: 70px; }
    body, html { margin: 0; padding: 0; height: 100%; background: var(--panel-bg); color: white; overflow: hidden; font-family: sans-serif; }
    
    .dc-layout { display: flex; flex-direction: column; height: 100vh; }
    
    header { 
      height: var(--header-h); background: #0f1a14; display: flex; align-items: center; 
      padding: 0 20px; border-bottom: 1px solid #1d2d23; justify-content: space-between;
    }
    .dc-brand { display: flex; align-items: center; gap: 15px; }
    .dc-brand img { height: 40px; }
    
    .dc-main { flex: 1; display: flex; position: relative; }
    #mapDC { flex: 1; background: #000; }

    .side-panel { 
      width: 300px; background: #0f1a14; border-left: 1px solid #1d2d23; 
      display: flex; flex-direction: column; padding: 15px; overflow-y: auto;
    }

    .selector-box { margin-bottom: 20px; }
    select { width: 100%; padding: 10px; background: #000; color: #17a34a; border: 1px solid #1d2d23; border-radius: 5px; font-weight: bold; }

    .radio-status-list { list-style: none; padding: 0; }
    .radio-item { 
      background: #16251b; padding: 10px; border-radius: 6px; margin-bottom: 8px; 
      display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #333;
    }
    .radio-item.active { border-left-color: #17a34a; }
    .radio-num { font-weight: bold; color: #888; }
    .radio-car { font-size: 1.2rem; font-weight: bold; color: #17a34a; }

    /* Estilo para los Labels del Mapa */
    .radio-label {
      background: #17a34a; border: 2px solid white; border-radius: 50%;
      color: white; font-weight: bold; text-align: center; line-height: 30px;
      width: 30px !important; height: 30px !important; margin-left: -15px; margin-top: -15px;
    }
    .radio-label.empty { background: #333; border-color: #666; }
  </style>
</head>
<body>

<div class="dc-layout">
  <header>
    <div class="dc-brand">
      <img id="dcLogo" src="logo.svg" onerror="this.src='logo.png'">
      <h2 id="dcTitle" style="margin:0; font-size: 1.2rem;">Dirección de Carrera</h2>
    </div>
    <div id="rallyClock" style="font-family: monospace; font-size: 1.5rem; color: #17a34a;">00:00:00</div>
  </header>

  <div class="dc-main">
    <div id="mapDC"></div>

    <aside class="side-panel">
      <div class="selector-box">
        <label style="font-size: 0.7rem; color: #888;">TRAMO ACTUAL</label>
        <select id="selectTramo" onchange="cambiarTramo(this.value)">
          <option value="">Seleccionar tramo...</option>
        </select>
      </div>

      <h3 style="font-size: 0.9rem; color: #17a34a; border-bottom: 1px solid #1d2d23; padding-bottom: 5px;">ESTADO RADIOS</h3>
      <div id="radiosList" class="radio-status-list">
        </div>
    </aside>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  if (!firebase.apps.length) firebase.initializeApp(window.FIREBASE_CONFIG);
  const db = firebase.firestore();
  
  let map, trackLayer, radioMarkers = {};
  let currentRallyId = new URLSearchParams(window.location.search).get('id');
  let configRally = null;

  // 1. Inicializar Mapa
  function initMap() {
    map = L.map('mapDC').setView([37.88, -4.77], 12);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
    trackLayer = L.featureGroup().addTo(map);
  }

  // 2. Cargar Configuración del Rally
  async function cargarConfiguracion() {
    if(!currentRallyId) {
        currentRallyId = prompt("Introduce ID del Rally:");
        if(!currentRallyId) return;
    }

    const doc = await db.collection("config_rallies").doc(currentRallyId).get();
    if(doc.exists) {
      configRally = doc.data();
      document.getElementById('dcLogo').src = configRally.logo;
      document.getElementById('dcTitle').innerText = configRally.nombre;
      
      const select = document.getElementById('selectTramo');
      configRally.tramos.forEach((t, idx) => {
        let opt = document.createElement('option');
        opt.value = idx;
        opt.innerText = t.nombre;
        select.appendChild(opt);
      });
    }
  }

  // 3. Cambiar de Tramo y dibujar
  function cambiarTramo(idx) {
    if(idx === "") return;
    const tramo = configRally.tramos[idx];
    trackLayer.clearLayers();
    radioMarkers = {};
    document.getElementById('radiosList').innerHTML = "";

    // Dibujar línea
    if(tramo.track.length) {
      const poly = L.polyline(tramo.track, {color: '#17a34a', weight: 4, opacity: 0.6}).addTo(trackLayer);
      map.fitBounds(poly.getBounds());
    }

    // Dibujar puntos de radio (inicialmente vacíos)
    tramo.radios.forEach((r, i) => {
      const rNum = i + 1;
      const icon = L.divIcon({
        className: 'radio-label empty',
        html: rNum,
        iconSize: [30, 30]
      });
      const marker = L.marker([r.lat, r.lng], {icon: icon}).addTo(trackLayer);
      radioMarkers[rNum] = marker;

      // Añadir a la lista lateral
      const item = document.createElement('div');
      item.className = 'radio-item';
      item.id = `sidebar-radio-${rNum}`;
      item.innerHTML = `<span class="radio-num">RADIO ${rNum}</span> <span class="radio-car" id="val-radio-${rNum}">--</span>`;
      document.getElementById('radiosList').appendChild(item);
    });

    escucharPasoDeCoches(tramo.nombre);
  }

  // 4. ESCUCHA TIEMPO REAL: Cuando un radio pulsa un botón
  function escucharPasoDeCoches(nombreTramo) {
    // Escuchamos en la colección de logs o estados de radio
    // Asumimos que los radios guardan en: rallies/{rallyId}/pasos/{tramo}/radioX -> {dorsal: "12"}
    db.collection("rallies").doc(currentRallyId)
      .collection("pasos").doc(nombreTramo).onSnapshot(doc => {
        if(!doc.exists) return;
        const data = doc.data();
        
        Object.keys(data).forEach(radioKey => {
          const rNum = radioKey.replace('radio', '');
          const dorsal = data[radioKey];
          actualizarVisualRadio(rNum, dorsal);
        });
    });
  }

  function actualizarVisualRadio(num, dorsal) {
    if(radioMarkers[num]) {
      // Actualizar mapa: Quitar clase 'empty' y poner el dorsal
      const icon = L.divIcon({
        className: 'radio-label',
        html: dorsal,
        iconSize: [30, 30]
      });
      radioMarkers[num].setIcon(icon);
      
      // Actualizar lateral
      const valEl = document.getElementById(`val-radio-${num}`);
      if(valEl) valEl.innerText = "#" + dorsal;
      document.getElementById(`sidebar-radio-${num}`).classList.add('active');
    }
  }

  // Reloj
  setInterval(() => {
    document.getElementById('rallyClock').innerText = new Date().toLocaleTimeString('es-ES', {hour12:false});
  }, 1000);

  initMap();
  cargarConfiguracion();
</script>

</body>
</html>
