<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SECeD - Editor de Rallies</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <style>
        :root { --bg: #0b120e; --card: #0f1a14; --border: #1d2d23; --accent: #17a34a; --text: #e6f2ea; }
        body { background-color: var(--bg); color: var(--text); font-family: sans-serif; padding: 20px; }
        .header-box { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 20px; }
        input[type="text"] { width: 100%; padding: 10px; background: #000; border: 1px solid var(--border); color: white; border-radius: 6px; margin-bottom: 10px; }
        .tc-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px; position: relative; }
        .map-editor { height: 400px; width: 100%; border-radius: 8px; margin-top: 10px; border: 1px solid #333; }
        .btn { padding: 12px 20px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; width: 100%; }
        .btn-add { background: #1e293b; color: white; margin-bottom: 20px; }
        .btn-save { background: var(--accent); color: white; font-size: 1.2rem; }
        .btn-remove { background: #7f1d1d; color: white; width: auto; position: absolute; top: 10px; right: 10px; padding: 5px 10px; }
    </style>
</head>
<body>

<div style="max-width: 900px; margin: auto;">
    <div class="header-box">
        <h1>Configurador de Rally</h1>
        <input type="text" id="rallyId" placeholder="ID Ãšnico (ej: rally-cordoba-25)">
        <input type="text" id="rallyNombre" placeholder="Nombre del Rally">
        <input type="text" id="rallyLogo" placeholder="URL del Logo">
    </div>

    <div id="tramosList"></div>
    <button class="btn btn-add" onclick="agregarTramo()">+ AÃ‘ADIR NUEVO TRAMO (TC)</button>
    <button class="btn btn-save" onclick="guardarRallyEnFirebase()">ðŸ’¾ GUARDAR RALLY COMPLETO</button>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

<script>
    if (!firebase.apps.length) firebase.initializeApp(window.FIREBASE_CONFIG);
    const db = firebase.firestore();
    let tramoCount = 0;

    function agregarTramo() {
        tramoCount++;
        const idMap = `map_${tramoCount}`;
        const tramoHtml = `<div class="tc-card" id="card_${idMap}">
            <button class="btn btn-remove" onclick="document.getElementById('card_${idMap}').remove()">Eliminar</button>
            <input type="text" class="tc-name" placeholder="Nombre del Tramo (ej: TC1)">
            <div id="${idMap}" class="map-editor"></div>
            <input type="hidden" class="tc-track-data">
        </div>`;
        document.getElementById('tramosList').insertAdjacentHTML('beforeend', tramoHtml);
        setTimeout(() => inicializarMapaEditor(idMap), 50);
    }

    function inicializarMapaEditor(mapId) {
        const map = L.map(mapId).setView([37.88, -4.77], 12);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
        const drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);
        const drawControl = new L.Control.Draw({
            draw: { polyline: { shapeOptions: { color: '#17a34a', weight: 5 } }, polygon: false, circle: false, rectangle: false, marker: false, circlemarker: false },
            edit: { featureGroup: drawnItems }
        });
        map.addControl(drawControl);
        map.on(L.Draw.Event.CREATED, function (e) {
            drawnItems.clearLayers();
            drawnItems.addLayer(e.layer);
            // IMPORTANTE: Guardamos como array de objetos {lat, lng} para evitar el error de Firestore
            const coords = e.layer.getLatLngs().map(latlng => ({ lat: latlng.lat, lng: latlng.lng }));
            document.querySelector(`#card_${mapId} .tc-track-data`).value = JSON.stringify(coords);
        });
    }

    async function guardarRallyEnFirebase() {
        const id = document.getElementById('rallyId').value.trim();
        if (!id) return alert("Falta ID del Rally");
        const tramos = [];
        document.querySelectorAll('.tc-card').forEach(card => {
            const trackStr = card.querySelector('.tc-track-data').value;
            tramos.push({ 
                nombre: card.querySelector('.tc-name').value, 
                track: trackStr ? JSON.parse(trackStr) : [] 
            });
        });
        try {
            await db.collection("config_rallies").doc(id).set({
                nombre: document.getElementById('rallyNombre').value,
                logo: document.getElementById('rallyLogo').value,
                tramos: tramos
            });
            alert("Rally guardado correctamente en Firebase.");
        } catch (e) { alert("Error al guardar: " + e.message); }
    }
</script>
</body>
</html>
