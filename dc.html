<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SECeD - Dirección de Carrera</title>

<link rel="stylesheet" href="styles.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
.grid-dc { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px; width: 100%; box-sizing: border-box; }
.tc-selector-bar { padding: 10px 20px; display: flex; flex-wrap: wrap; gap: 10px; background: #0f1a14; border-bottom: 1px solid #1d2d23; }
.btn-tc-toggle { background: #1e293b; color: white; border: 1px solid #334155; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; }
.btn-tc-toggle.active { background: #16a34a; border-color: #fff; }
.card-dc { background: #0f1a14; border: 1px solid #1d2d23; border-radius: 12px; padding: 15px; display: flex; flex-direction: column; height: 500px; }
.card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
.map-dc { flex: 1; border-radius: 8px; background: #000; border: 1px solid #1d2d23; z-index: 1; }

.btn-stop { background: #7f1d1d; color: white; border: none; padding: 10px 15px; border-radius: 5px; font-weight: 800; cursor: pointer; }
.btn-stop.blink { background: #ff0000; animation: blinker 1s linear infinite; box-shadow: 0 0 15px #ff0000; }
@keyframes blinker { 50% { opacity: 0.4; } }
.btn-resume { background: #15803d; color: white; border: 1px solid #16a34a; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-weight: 800; margin-left: 5px; }

.radio-badge { background: #333; border: 2px solid #666; border-radius: 20px; color: #fff; font-weight: bold; text-align: center; min-width: 70px; padding: 2px 6px; font-size: 13px; }
.radio-badge.active { background: #ffd60a; color: #000; border-color: #fff; }
.tc-title { color: #22c55e; font-size: 1.3rem; margin: 0; font-weight: 900; }

@media (max-width: 900px) { .grid-dc { grid-template-columns: 1fr; } }
</style>
</head>

<body>
<main class="app">
<div class="brand"><img id="dcLogo" src="logo.svg" class="brand-logo" onerror="this.src='logo.png'"/></div>
<h1 id="dcRallyName">SECeD - Dirección de Carrera</h1>
<div id="tcSelector" class="tc-selector-bar"></div>
<div id="gridDC" class="grid-dc"></div>
</main>

<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>

let db;
let rallyId = new URLSearchParams(window.location.search).get('id');
let configGlobal = null;
let tramosVisibles = new Set();

async function initDC() {

if (!firebase.apps.length) firebase.initializeApp(window.FIREBASE_CONFIG);
db = firebase.firestore();

if (!rallyId) {
rallyId = prompt("Introduce ID del Rally:");
if (!rallyId) return;
window.location.href = window.location.href + "?id=" + rallyId;
return;
}

const doc = await db.collection("config_rallies").doc(rallyId).get();
if (!doc.exists) {
alert("ID no existe.");
return;
}

configGlobal = doc.data();

document.getElementById('dcLogo').src = configGlobal.logo || 'logo.png';
document.getElementById('dcRallyName').innerText = configGlobal.nombre || 'SECeD - DC';

const selector = document.getElementById('tcSelector');
selector.innerHTML = "";

configGlobal.tramos.forEach((tramo, index) => {
const btn = document.createElement('button');
btn.className = 'btn-tc-toggle';
btn.innerText = tramo.nombre || ('Tramo ' + (index+1));

btn.onclick = () => {
if (tramosVisibles.has(index)) {
tramosVisibles.delete(index);
btn.classList.remove('active');
} else {
tramosVisibles.add(index);
btn.classList.add('active');
}
renderizarGrid();
};

selector.appendChild(btn);
});
}

function renderizarGrid() {

const container = document.getElementById('gridDC');
container.innerHTML = "";

configGlobal.tramos.forEach((tramo, index) => {

if (!tramosVisibles.has(index)) return;

const nombre = tramo.nombre || ('Tramo ' + (index+1));
const tId = nombre.replace(/\s+/g, '_');

container.insertAdjacentHTML('beforeend', `
<div class="card-dc">
<div class="card-header">
<h2 class="tc-title">${nombre}</h2>
</div>
<div id="map-${tId}" class="map-dc"></div>
</div>
`);

setTimeout(() => {

const map = L.map(`map-${tId}`).setView([37.88, -4.77], 12);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

if (tramo.track) {
const poly = L.polyline(tramo.track, {color: '#22c55e', weight: 4}).addTo(map);
map.fitBounds(poly.getBounds());
}

// ===== SALIDA =====
if (tramo.salida?.lat) {
const iconSalida = L.icon({
iconUrl: configGlobal.iconoSalida || 'https://cdn-icons-png.flaticon.com/512/190/190411.png',
iconSize: [32,32],
iconAnchor: [16,32]
});
L.marker([tramo.salida.lat, tramo.salida.lng], {icon: iconSalida}).addTo(map);
}

// ===== META =====
if (tramo.meta?.lat) {
const iconMeta = L.icon({
iconUrl: configGlobal.iconoMeta || 'https://cdn-icons-png.flaticon.com/512/190/190406.png',
iconSize: [32,32],
iconAnchor: [16,32]
});
L.marker([tramo.meta.lat, tramo.meta.lng], {icon: iconMeta}).addTo(map);
}

// ===== RADIOS =====
const badgeRefs = {};

if (tramo.radios) {
tramo.radios.forEach((r, rIdx) => {
const nR = rIdx + 1;

const icon = L.divIcon({
className: '',
html: `<div class="radio-badge" id="badge-${tId}-${nR}">R${nR}: --</div>`,
iconSize: [80,25]
});

L.marker([r.lat, r.lng], {icon}).addTo(map);
badgeRefs[nR] = document.getElementById(`badge-${tId}-${nR}`);
});
}

// ===== SUSCRIPCIÓN RESET CORREGIDA =====
suscribirClicksRadios(nombre, tId, badgeRefs);

}, 50);

});
}


// ================= RESET VISUAL REAL =================

function suscribirClicksRadios(tramoNombre, tId, badgeRefs) {

const tramoDoc = db.collection('tramos').doc(String(tramoNombre));

tramoDoc.collection('radios').onSnapshot(snap => {

if (snap.empty) {
// Limpieza total visual
Object.keys(badgeRefs).forEach(n => {
const b = badgeRefs[n];
if (b) {
b.classList.remove('active');
b.innerText = `R${n}: --`;
}
});
return;
}

const ultPorRadio = {};

snap.forEach(doc => {

const dorsal = Number(doc.id);
if (!Number.isFinite(dorsal) || dorsal <= 0) return;

const d = doc.data() || {};
const marks = Array.isArray(d.marks) ? d.marks : [];
const last = (typeof d.last === 'number') ? d.last : 0;

marks.forEach(r => {
const n = String(r);
if (!(n in ultPorRadio) || dorsal > ultPorRadio[n]) {
ultPorRadio[n] = dorsal;
}
});

if (last > 0) {
const n = String(last);
if (!(n in ultPorRadio) || dorsal > ultPorRadio[n]) {
ultPorRadio[n] = dorsal;
}
}
});

// Refrescar visual completo
Object.keys(badgeRefs).forEach(n => {
const b = badgeRefs[n];
if (!b) return;

const valor = ultPorRadio[String(n)];

if (Number.isFinite(valor)) {
b.classList.add('active');
b.innerText = `R${n}: ${valor}`;
} else {
b.classList.remove('active');
b.innerText = `R${n}: --`;
}
});

}, err => {
console.warn('onSnapshot radios error', err);
});
}

window.onload = initDC;

</script>
</body>
</html>
