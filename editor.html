<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SECeD - Editor de Rallies PRO</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>

<style>
:root{--bg:#0b120e;--card:#0f1a14;--border:#1d2d23;--accent:#17a34a;--text:#e6f2ea;}
body{background:var(--bg);color:var(--text);font-family:sans-serif;padding:20px;margin:0;}
.container{max-width:950px;margin:auto;}
.header-box{background:var(--card);padding:25px;border-radius:12px;border:1px solid var(--border);margin-bottom:20px;}
h1{color:var(--accent);margin-top:0;}
label{display:block;margin-bottom:5px;font-weight:bold;font-size:0.85rem;color:#888;}
input[type="text"],input[type="file"]{width:100%;padding:12px;background:#000;border:1px solid var(--border);color:white;border-radius:6px;margin-bottom:15px;box-sizing:border-box;}
.tc-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:20px;position:relative;}
.map-editor{height:450px;width:100%;border-radius:8px;margin-top:10px;border:1px solid #333;}
.btn{padding:10px;border-radius:6px;border:none;font-weight:bold;cursor:pointer;margin-bottom:6px;}
.btn-add{background:#1e293b;color:white;}
.btn-save{background:var(--accent);color:white;font-size:1.2rem;width:100%;margin-top:20px;}
.btn-remove{background:#7f1d1d;color:white;position:absolute;top:15px;right:15px;font-size:0.8rem;padding:6px 12px;}
.preview-img{max-height:80px;display:none;margin-bottom:15px;}
.loading-tag{color:#fbbf24;font-size:0.8rem;display:none;margin-left:10px;}
.map-buttons{margin-top:10px;margin-bottom:10px;}
</style>
</head>

<body>
<div class="container">
<div class="header-box">
<h1>Configurador de Rally <span id="loadingStatus" class="loading-tag">Cargando datos...</span></h1>

<label>ID √öNICO DEL RALLY</label>
<input type="text" id="rallyId" onblur="verificarRallyExistente(this.value)">

<label>NOMBRE P√öBLICO DEL RALLY</label>
<input type="text" id="rallyNombre">

<label>LOGO / PLACA DEL RALLY (Se comprimir√° autom√°ticamente)</label>
<input type="file" accept="image/*" onchange="procesarYComprimirImagen(this)">
<img id="imgPreview" class="preview-img">
<input type="hidden" id="rallyLogoBase64">

<label>ICONO SALIDA PERSONALIZADO (Opcional)</label>
<input type="file" accept="image/*" onchange="subirIcono(this,'salida')">
<input type="hidden" id="iconoSalidaBase64">

<label>ICONO META PERSONALIZADO (Opcional)</label>
<input type="file" accept="image/*" onchange="subirIcono(this,'meta')">
<input type="hidden" id="iconoMetaBase64">
</div>

<div id="tramosList"></div>

<button class="btn btn-add" onclick="agregarTramo()">+ A√ëADIR NUEVO TRAMO</button>
<button class="btn btn-save" onclick="guardarRallyCompleto()">üíæ GUARDAR / ACTUALIZAR</button>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

<script>
if(!firebase.apps.length)firebase.initializeApp(window.FIREBASE_CONFIG);
const db=firebase.firestore();
let tramoCount=0;
let iconoSalidaGlobal=null;
let iconoMetaGlobal=null;
const LOGO_GENERICO="logo.png";

/* ================= CARGAR ================= */

async function verificarRallyExistente(id){
if(!id)return;
document.getElementById('loadingStatus').style.display="inline";

const doc=await db.collection("config_rallies").doc(id).get();
if(doc.exists){
const data=doc.data();

document.getElementById('rallyNombre').value=data.nombre||"";

if(data.logo){
document.getElementById('rallyLogoBase64').value=data.logo;
document.getElementById('imgPreview').src=data.logo;
document.getElementById('imgPreview').style.display='block';
}

iconoSalidaGlobal=data.iconoSalida||null;
iconoMetaGlobal=data.iconoMeta||null;

document.getElementById('tramosList').innerHTML="";
tramoCount=0;

if(data.tramos){
data.tramos.forEach(t=>{
agregarTramoConDatos(
t.nombre,
t.track||[],
t.radios||[],
t.salida||null,
t.meta||null
);
});
}
}

document.getElementById('loadingStatus').style.display="none";
}

/* ================= TRAMOS ================= */

function agregarTramoConDatos(nombre="",track=[],radios=[],salida=null,meta=null){
tramoCount++;
const idMap=`map_${tramoCount}`;

const html=`
<div class="tc-card" id="card_${idMap}">
<button class="btn btn-remove" onclick="document.getElementById('card_${idMap}').remove()">Eliminar</button>

<label>NOMBRE DEL TRAMO</label>
<input type="text" class="tc-name" value="${nombre}">

<button class="btn btn-add" onclick="duplicarTramo('${idMap}',true)">Duplicar con radios</button>
<button class="btn btn-add" onclick="duplicarTramo('${idMap}',false)">Duplicar sin radios</button>

<div class="map-buttons">
<button class="btn btn-add" onclick="activarModo('${idMap}','salida')">üü¢ Colocar Salida</button>
<button class="btn btn-add" onclick="activarModo('${idMap}','meta')">üèÅ Colocar Meta</button>
</div>

<div id="${idMap}" class="map-editor"></div>

<input type="hidden" class="tc-track-data" value='${JSON.stringify(track)}'>
<input type="hidden" class="tc-radios-data" value='${JSON.stringify(radios)}'>
<input type="hidden" class="tc-salida-data" value='${JSON.stringify(salida)}'>
<input type="hidden" class="tc-meta-data" value='${JSON.stringify(meta)}'>
</div>`;

document.getElementById('tramosList').insertAdjacentHTML('beforeend',html);
setTimeout(()=>initMapa(idMap,track,radios,salida,meta),100);
}

function agregarTramo(){agregarTramoConDatos();}

function duplicarTramo(idMap,conRadios){
const card=document.getElementById('card_'+idMap);
const nombre=card.querySelector('.tc-name').value+" (Copia)";
const track=JSON.parse(card.querySelector('.tc-track-data').value||"[]");
const radios=conRadios?JSON.parse(card.querySelector('.tc-radios-data').value||"[]"):[];
agregarTramoConDatos(nombre,track,radios,null,null);
}

/* ================= MAPA ================= */

let modoActivo={};

function activarModo(id,tipo){
modoActivo[id]=tipo;
}

function getSalidaIcon(){
return L.icon({
iconUrl:iconoSalidaGlobal||'https://cdn-icons-png.flaticon.com/512/190/190411.png',
iconSize:[32,32],
iconAnchor:[16,32]
});
}

function getMetaIcon(){
return L.icon({
iconUrl:iconoMetaGlobal||'https://cdn-icons-png.flaticon.com/512/190/190406.png',
iconSize:[32,32],
iconAnchor:[16,32]
});
}

function initMapa(id,existingTrack,existingRadios,existingSalida,existingMeta){

const map=L.map(id).setView([37.88,-4.77],12);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

const drawnItems=new L.FeatureGroup();
map.addLayer(drawnItems);

let salidaMarker=null;
let metaMarker=null;

/* TRACK */
if(existingTrack?.length){
const poly=L.polyline(existingTrack,{color:'#17a34a',weight:5}).addTo(drawnItems);
map.fitBounds(poly.getBounds());
}

/* RADIOS */
if(existingRadios){
existingRadios.forEach((r,i)=>{
const m=L.marker([r.lat,r.lng]).addTo(drawnItems);
m.tipo="radio";
m.bindTooltip("Radio "+(i+1),{permanent:true});
});
}

/* SALIDA */
if(existingSalida){
salidaMarker=L.marker([existingSalida.lat,existingSalida.lng],
{icon:getSalidaIcon(),draggable:true}).addTo(drawnItems);

salidaMarker.on('dragend',()=>{
const pos=salidaMarker.getLatLng();
document.querySelector(`#card_${id} .tc-salida-data`).value=
JSON.stringify({lat:pos.lat,lng:pos.lng});
});
}

/* META */
if(existingMeta){
metaMarker=L.marker([existingMeta.lat,existingMeta.lng],
{icon:getMetaIcon(),draggable:true}).addTo(drawnItems);

metaMarker.on('dragend',()=>{
const pos=metaMarker.getLatLng();
document.querySelector(`#card_${id} .tc-meta-data`).value=
JSON.stringify({lat:pos.lat,lng:pos.lng});
});
}

/* CLICK PARA COLOCAR */
map.on('click',function(e){

if(!modoActivo[id])return;

if(modoActivo[id]==="salida"){
if(salidaMarker)drawnItems.removeLayer(salidaMarker);
salidaMarker=L.marker(e.latlng,{icon:getSalidaIcon(),draggable:true}).addTo(drawnItems);
salidaMarker.on('dragend',()=>{
const pos=salidaMarker.getLatLng();
document.querySelector(`#card_${id} .tc-salida-data`).value=
JSON.stringify({lat:pos.lat,lng:pos.lng});
});
document.querySelector(`#card_${id} .tc-salida-data`).value=
JSON.stringify({lat:e.latlng.lat,lng:e.latlng.lng});
}

if(modoActivo[id]==="meta"){
if(metaMarker)drawnItems.removeLayer(metaMarker);
metaMarker=L.marker(e.latlng,{icon:getMetaIcon(),draggable:true}).addTo(drawnItems);
metaMarker.on('dragend',()=>{
const pos=metaMarker.getLatLng();
document.querySelector(`#card_${id} .tc-meta-data`).value=
JSON.stringify({lat:pos.lat,lng:pos.lng});
});
document.querySelector(`#card_${id} .tc-meta-data`).value=
JSON.stringify({lat:e.latlng.lat,lng:e.latlng.lng});
}

modoActivo[id]=null;
});
}

/* ================= LOGO ================= */

function procesarYComprimirImagen(input){
const file=input.files[0]; if(!file)return;
const reader=new FileReader();
reader.onload=function(e){
const img=new Image();
img.onload=function(){
const canvas=document.createElement('canvas');
const MAX=400; let w=img.width,h=img.height;
if(w>MAX){h*=MAX/w;w=MAX;}
canvas.width=w; canvas.height=h;
const ctx=canvas.getContext('2d');
ctx.drawImage(img,0,0,w,h);
const base64=canvas.toDataURL('image/jpeg',0.7);
document.getElementById('rallyLogoBase64').value=base64;
document.getElementById('imgPreview').src=base64;
document.getElementById('imgPreview').style.display='block';
};
img.src=e.target.result;
};
reader.readAsDataURL(file);
}

function subirIcono(input,tipo){
const file=input.files[0]; if(!file)return;
const reader=new FileReader();
reader.onload=e=>{
if(tipo==="salida") iconoSalidaGlobal=e.target.result;
if(tipo==="meta") iconoMetaGlobal=e.target.result;
};
reader.readAsDataURL(file);
}

/* ================= GUARDAR ================= */

async function guardarRallyCompleto(){
const id=document.getElementById('rallyId').value.trim();
const nombre=document.getElementById('rallyNombre').value.trim();
let logo=document.getElementById('rallyLogoBase64').value||LOGO_GENERICO;
if(!id||!nombre)return alert("Falta ID o Nombre");

const tramos=[];
document.querySelectorAll('.tc-card').forEach(card=>{
tramos.push({
nombre:card.querySelector('.tc-name').value,
track:JSON.parse(card.querySelector('.tc-track-data').value||"[]"),
radios:JSON.parse(card.querySelector('.tc-radios-data').value||"[]"),
salida:JSON.parse(card.querySelector('.tc-salida-data').value||"null"),
meta:JSON.parse(card.querySelector('.tc-meta-data').value||"null")
});
});

await db.collection("config_rallies").doc(id).set({
nombre,logo,tramos,
iconoSalida:iconoSalidaGlobal||null,
iconoMeta:iconoMetaGlobal||null,
ultimaEdicion:new Date().toISOString()
});

alert("‚úÖ Rally guardado correctamente.");
}
</script>
</body>
</html>
