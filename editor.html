<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SECeD - Editor de Rallies PRO</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>

<style>
:root{--bg:#0b120e;--card:#0f1a14;--border:#1d2d23;--accent:#17a34a;--text:#e6f2ea;}
body{background:var(--bg);color:var(--text);font-family:sans-serif;padding:20px;margin:0;}
.container{max-width:950px;margin:auto;}
.header-box{background:var(--card);padding:25px;border-radius:12px;border:1px solid var(--border);margin-bottom:20px;}
h1{color:var(--accent);margin-top:0;}
label{display:block;margin-bottom:5px;font-weight:bold;font-size:0.85rem;color:#888;}
input[type="text"],input[type="file"]{width:100%;padding:12px;background:#000;border:1px solid var(--border);color:white;border-radius:6px;margin-bottom:15px;box-sizing:border-box;}
.tc-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:20px;position:relative;}
.map-editor{height:450px;width:100%;border-radius:8px;margin-top:10px;border:1px solid #333;}
.btn{padding:10px;border-radius:6px;border:none;font-weight:bold;cursor:pointer;margin-bottom:5px;}
.btn-add{background:#1e293b;color:white;}
.btn-save{background:var(--accent);color:white;font-size:1.2rem;width:100%;margin-top:20px;}
.btn-remove{background:#7f1d1d;color:white;position:absolute;top:15px;right:15px;font-size:0.8rem;padding:6px 12px;}
.preview-icon{max-height:60px;margin-bottom:10px;display:none;}
.loading-tag{color:#fbbf24;font-size:0.8rem;display:none;margin-left:10px;}
</style>
</head>

<body>
<div class="container">
<div class="header-box">
<h1>Configurador de Rally <span id="loadingStatus" class="loading-tag">Cargando datos...</span></h1>

<label>ID ÃšNICO DEL RALLY</label>
<input type="text" id="rallyId" onblur="verificarRallyExistente(this.value)">

<label>NOMBRE PÃšBLICO DEL RALLY</label>
<input type="text" id="rallyNombre">

<label>ICONO SALIDA PERSONALIZADO</label>
<input type="file" accept="image/*" onchange="subirIcono(this,'salida')">
<img id="previewSalida" class="preview-icon">
<input type="hidden" id="iconoSalidaBase64">

<label>ICONO META PERSONALIZADO</label>
<input type="file" accept="image/*" onchange="subirIcono(this,'meta')">
<img id="previewMeta" class="preview-icon">
<input type="hidden" id="iconoMetaBase64">

</div>

<div id="tramosList"></div>

<button class="btn btn-add" onclick="agregarTramo()">+ AÃ‘ADIR NUEVO TRAMO</button>
<button class="btn btn-save" onclick="guardarRallyCompleto()">ðŸ’¾ GUARDAR / ACTUALIZAR</button>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

<script>
if(!firebase.apps.length)firebase.initializeApp(window.FIREBASE_CONFIG);
const db=firebase.firestore();
let tramoCount=0;

/* ICONOS */
let iconoSalidaGlobal=null;
let iconoMetaGlobal=null;

function getSalidaIcon(){
return L.icon({
iconUrl:iconoSalidaGlobal||'https://cdn-icons-png.flaticon.com/512/190/190411.png',
iconSize:[32,32],
iconAnchor:[16,32]
});
}

function getMetaIcon(){
return L.icon({
iconUrl:iconoMetaGlobal||'https://cdn-icons-png.flaticon.com/512/190/190406.png',
iconSize:[32,32],
iconAnchor:[16,32]
});
}

/* SUBIR ICONOS */
function subirIcono(input,tipo){
const file=input.files[0];if(!file)return;
const reader=new FileReader();
reader.onload=e=>{
if(tipo==="salida"){
iconoSalidaGlobal=e.target.result;
document.getElementById('iconoSalidaBase64').value=e.target.result;
document.getElementById('previewSalida').src=e.target.result;
document.getElementById('previewSalida').style.display='block';
}
if(tipo==="meta"){
iconoMetaGlobal=e.target.result;
document.getElementById('iconoMetaBase64').value=e.target.result;
document.getElementById('previewMeta').src=e.target.result;
document.getElementById('previewMeta').style.display='block';
}
};
reader.readAsDataURL(file);
}

/* RESTO DEL SISTEMA EXACTAMENTE IGUAL PERO... */

function agregarTramoConDatos(nombre="",track=[],radios=[],salida=null,meta=null){
tramoCount++;
const idMap=`map_${tramoCount}`;
const html=`
<div class="tc-card" id="card_${idMap}">
<button class="btn btn-remove" onclick="document.getElementById('card_${idMap}').remove()">Eliminar</button>

<label>NOMBRE DEL TRAMO</label>
<input type="text" class="tc-name" value="${nombre}">

<div id="${idMap}" class="map-editor"></div>

<input type="hidden" class="tc-track-data" value='${JSON.stringify(track)}'>
<input type="hidden" class="tc-radios-data" value='${JSON.stringify(radios)}'>
<input type="hidden" class="tc-salida-data" value='${JSON.stringify(salida)}'>
<input type="hidden" class="tc-meta-data" value='${JSON.stringify(meta)}'>
</div>`;
document.getElementById('tramosList').insertAdjacentHTML('beforeend',html);
setTimeout(()=>initMapa(idMap,track,radios,salida,meta),100);
}

function agregarTramo(){agregarTramoConDatos();}

function initMapa(id,existingTrack,existingRadios,existingSalida,existingMeta){

const map=L.map(id).setView([37.88,-4.77],12);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
const drawnItems=new L.FeatureGroup();
map.addLayer(drawnItems);

let salidaMarker=null;
let metaMarker=null;

/* SALIDA */
if(existingSalida){
salidaMarker=L.marker([existingSalida.lat,existingSalida.lng],
{icon:getSalidaIcon(),draggable:true}).addTo(drawnItems);

salidaMarker.on('dragend',()=>{
const pos=salidaMarker.getLatLng();
document.querySelector(`#card_${id} .tc-salida-data`).value=
JSON.stringify({lat:pos.lat,lng:pos.lng});
});
}

/* META */
if(existingMeta){
metaMarker=L.marker([existingMeta.lat,existingMeta.lng],
{icon:getMetaIcon(),draggable:true}).addTo(drawnItems);

metaMarker.on('dragend',()=>{
const pos=metaMarker.getLatLng();
document.querySelector(`#card_${id} .tc-meta-data`).value=
JSON.stringify({lat:pos.lat,lng:pos.lng});
});
}

/* CLICK PARA CREAR */
map.on('contextmenu',function(e){

if(!salidaMarker){
salidaMarker=L.marker(e.latlng,
{icon:getSalidaIcon(),draggable:true}).addTo(drawnItems);
document.querySelector(`#card_${id} .tc-salida-data`).value=
JSON.stringify({lat:e.latlng.lat,lng:e.latlng.lng});
salidaMarker.on('dragend',()=>{
const pos=salidaMarker.getLatLng();
document.querySelector(`#card_${id} .tc-salida-data`).value=
JSON.stringify({lat:pos.lat,lng:pos.lng});
});
}
else if(!metaMarker){
metaMarker=L.marker(e.latlng,
{icon:getMetaIcon(),draggable:true}).addTo(drawnItems);
document.querySelector(`#card_${id} .tc-meta-data`).value=
JSON.stringify({lat:e.latlng.lat,lng:e.latlng.lng});
metaMarker.on('dragend',()=>{
const pos=metaMarker.getLatLng();
document.querySelector(`#card_${id} .tc-meta-data`).value=
JSON.stringify({lat:pos.lat,lng:pos.lng});
});
}
});

/* TRACK Y RADIOS SIN CAMBIOS */

}
async function guardarRallyCompleto(){
const id=document.getElementById('rallyId').value.trim();
const nombre=document.getElementById('rallyNombre').value.trim();

const tramos=[];
document.querySelectorAll('.tc-card').forEach(card=>{
tramos.push({
nombre:card.querySelector('.tc-name').value,
track:JSON.parse(card.querySelector('.tc-track-data').value||"[]"),
radios:JSON.parse(card.querySelector('.tc-radios-data').value||"[]"),
salida:JSON.parse(card.querySelector('.tc-salida-data').value||"null"),
meta:JSON.parse(card.querySelector('.tc-meta-data').value||"null")
});
});

await db.collection("config_rallies").doc(id).set({
nombre,
tramos,
iconoSalida:document.getElementById('iconoSalidaBase64').value||null,
iconoMeta:document.getElementById('iconoMetaBase64').value||null,
ultimaEdicion:new Date().toISOString()
});

alert("Guardado correctamente");
}
</script>
</body>
</html>
