<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SECeD · Panel Radio</title>

  <!-- CSS global -->
  <link rel="stylesheet" href="styles.css?v=72">

  <!-- OVERRIDES SOLO PARA PANEL-RADIO -->
  <style>
    /* En Panel Radio: tarjetas en blanco SIEMPRE (también si .selected viene del editor) */
    html.is-radio body.viewer .grid .card,
    html.is-radio body.viewer .grid .card.selected{
      background:#fff !important; color:#111 !important;
      border-color:#e5e7eb !important; box-shadow:none !important;
    }
    /* Ocultamos franjas S/LL/A en Panel Radio */
    html.is-radio .time-stack{ display:none !important; }

    /* Estados opcionales si tu lógica de radio los usa */
    html.is-radio body.viewer .grid .card.radio-eligible{
      box-shadow:0 0 0 2px rgba(34,197,94,.35) inset !important; cursor:pointer !important;
    }
    html.is-radio body.viewer .grid .card.radio-clicked-by-me{
      background:#fef08a !important; border-color:#eab308 !important;
      box-shadow:0 0 0 2px rgba(234,179,8,.35) inset !important; cursor:default !important;
    }
    html.is-radio body.viewer .grid .card.radio-locked{
      opacity:.45 !important; filter:grayscale(.2) !important; cursor:default !important;
    }

    /* Cabecera */
    .topbar{display:flex;align-items:center;gap:12px;padding:8px 12px}
    .topbar .spacer{flex:1}
    .btn{padding:6px 10px;border:1px solid #2a2a2a;border-radius:8px;background:#111;color:#e5e7eb}
    .btn:hover{background:#1a1a1a}
    .badge{padding:4px 8px;border-radius:999px;background:#0b5; color:#fff; font-weight:700}
    .dropdown{position:relative;display:inline-block}
    .menu{position:absolute;top:calc(100% + 6px);left:0;background:#0d0f12;border:1px solid #2a2a2a;border-radius:10px;min-width:220px;z-index:50;padding:8px;display:none}
    .menu.show{display:block}
    .menu input{width:100%;padding:6px 8px;border-radius:8px;border:1px solid #2a2a2a;background:#0b0e11;color:#e5e7eb}
    .menu .row{display:flex;gap:8px;margin-top:8px}
    .menu button{flex:1}
  </style>

  <!-- MUY IMPORTANTE: marcar VISOR/RADIO y forzar ?viewer=1 ANTES de app.js -->
  <script>
    (function(){
      // fuerza flag de visor
      window.VIEWER = true;
      // añade ?viewer=1 si no está, para que app.js también lo detecte por URL
      try{
        const p = new URLSearchParams(location.search);
        if (!p.has('viewer')) {
          p.set('viewer','1');
          history.replaceState(null,'',location.pathname + '?' + p.toString());
        }
      }catch(e){}
      // marcos CSS
      document.addEventListener('DOMContentLoaded', function(){
        document.body.classList.add('viewer');
        document.documentElement.classList.add('is-radio');
      });
      // Bloquear el handler de "llegada" de app.js en esta página:
      // Capturamos los clics en .card y detenemos propagación para que
      // el listener que añade app.js (toggle llegada) no se ejecute.
      document.addEventListener('click', function(ev){
        const el = ev.target.closest && ev.target.closest('.card');
        if (!el) return;
        // Estamos en Panel Radio => impedir "llegada" de app.js
        ev.stopImmediatePropagation();
        ev.preventDefault();
        // Aquí puedes enganchar tu lógica propia de radio si la necesitas:
        // window.onRadioCardClick && window.onRadioCardClick(el.dataset.value);
      }, true); // <— captura
    })();
  </script>
</head>

<body>
  <!-- Cabecera con logo + controles -->
  <header class="topbar">
    <div class="brand" style="display:flex;align-items:center;gap:8px">
      <img src="assets/logo.png" alt="SECeD" style="height:40px">
      <strong>Panel Radio</strong>
    </div>

    <div class="spacer"></div>

    <!-- Botón TRAMO con desplegable -->
    <div class="dropdown" id="ddTramo">
      <button class="btn" id="btnTramo">TRAMO: — ▾</button>
      <div class="menu" id="menuTramo">
        <div>Seleccionar tramo</div>
        <input id="inTramo" placeholder="p.ej. 1 o tramo-a" />
        <div class="row">
          <button class="btn" id="goTramo">Usar</button>
          <button class="btn" id="closeTramo">Cerrar</button>
        </div>
      </div>
    </div>

    <!-- Botón RADIO con mini selector -->
    <div class="dropdown" id="ddRadio" style="margin-left:8px">
      <button class="btn" id="btnRadio">RADIO: — ▾</button>
      <div class="menu" id="menuRadio">
        <div>Indica tu radio (número)</div>
        <input id="inRadio" type="number" min="1" step="1" placeholder="1, 2, 3…" />
        <div class="row">
          <button class="btn" id="goRadio">Confirmar</button>
          <button class="btn" id="closeRadio">Cerrar</button>
        </div>
      </div>
    </div>

    <!-- Indicador actual a la derecha -->
    <div id="badgeRadio" class="badge" style="margin-left:8px;display:none">RADIO: —</div>

    <!-- Reloj -->
    <div class="clock" style="margin-left:12px">
      <span id="clockTime">--:--:--</span>
      <small id="clockTz" style="opacity:.75;margin-left:6px;">Europe/Madrid</small>
      <small id="clockSync" style="opacity:.75;margin-left:6px;">…</small>
    </div>
  </header>

  <main class="app">
    <div id="grid" class="grid"></div>
  </main>

  <!-- Firebase + config -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js?v=72"></script>

  <!-- Lógica compartida -->
  <script src="sync.js?v=72"></script>
  <script src="app.js?v=72"></script>

  <!-- UI TRAMO / RADIO + Reloj (no toca app.js) -->
  <script>
    (function(){
      function $(id){ return document.getElementById(id); }
      const btnTramo = $('btnTramo'), menuTramo = $('menuTramo'), inTramo = $('inTramo'),
            goTramo = $('goTramo'), closeTramo = $('closeTramo');
      const btnRadio = $('btnRadio'), menuRadio = $('menuRadio'), inRadio = $('inRadio'),
            goRadio = $('goRadio'), closeRadio = $('closeRadio'), badgeRadio = $('badgeRadio');

      // helpers
      function sanitizeTramo(t){ return (t||'').trim().toLowerCase().replace(/[^\w-]+/g,'-').slice(0,64); }
      function getParam(name){ return new URLSearchParams(location.search).get(name); }
      function setParam(name, val){
        const p = new URLSearchParams(location.search);
        p.set(name, val);
        location.search = p.toString();
      }
      function getRadio(){ try{return localStorage.getItem('seced_radio_idx')||'';}catch{return '';} }
      function setRadio(v){ try{localStorage.setItem('seced_radio_idx', (v||'').toString());}catch{} updateRadioBadge(); }

      // Init TRAMO badge
      function setTramoBadge(){
        const t = (window.TRAMO_ID || getParam('tramo') || '—').toString();
        btnTramo.textContent = `TRAMO: ${t} ▾`;
      }

      // Menús
      btnTramo.addEventListener('click', (e)=>{ e.stopPropagation(); menuTramo.classList.toggle('show'); inTramo.focus(); });
      closeTramo.addEventListener('click', ()=> menuTramo.classList.remove('show'));
      goTramo.addEventListener('click', ()=>{
        const t = sanitizeTramo(inTramo.value||'');
        if(!t) return;
        setParam('tramo', t); // recarga con tramo nuevo
      });

      btnRadio.addEventListener('click', (e)=>{ e.stopPropagation(); menuRadio.classList.toggle('show'); inRadio.focus(); });
      closeRadio.addEventListener('click', ()=> menuRadio.classList.remove('show'));
      goRadio.addEventListener('click', ()=>{
        const v = (inRadio.value||'').trim();
        if (!/^\d+$/.test(v)) return;
        setRadio(v);
        menuRadio.classList.remove('show');
      });

      document.addEventListener('click', ()=>{ menuTramo.classList.remove('show'); menuRadio.classList.remove('show'); });

      function updateRadioBadge(){
        const v = getRadio();
        if(v){ badgeRadio.style.display='inline-block'; badgeRadio.textContent = `RADIO: ${v}`; btnRadio.textContent = `RADIO: ${v} ▾`; }
        else { badgeRadio.style.display='none'; btnRadio.textContent='RADIO: — ▾'; }
      }

      // Clock (usa el mismo código base que en app.js, pero no lo duplicamos aquí;
      // app.js ya lo actualiza con worldtimeapi => solo aseguramos TZ visible)
      document.addEventListener('DOMContentLoaded', ()=> {
        const tzEl = document.getElementById('clockTz');
        if (tzEl) tzEl.textContent = 'Europe/Madrid';
      });

      // Init
      setTramoBadge();
      updateRadioBadge();
    })();
  </script>

  <!-- (OPCIONAL) Chips R:n debajo del dorsal; deja este bloque si ya guardas list:[radios] -->
  <script>
    (function(){
      const grid = document.getElementById('grid');
      if(!grid) return;
      const radioClicks = new Map();
      function paintChips(){
        const cells = grid.querySelectorAll('.cell');
        cells.forEach(cell=>{
          const card = cell.querySelector('.card'); if(!card) return;
          const val = card.dataset.value; if(!val) return;
          const old = cell.querySelector('.radio-chips'); if(old) old.remove();
          const list = radioClicks.get(String(val));
          if(!Array.isArray(list)||list.length===0) return;
          const wrap = document.createElement('div'); wrap.className='radio-chips';
          list.slice().sort((a,b)=>a-b).forEach(r=>{
            const chip=document.createElement('span'); chip.className='chip chip-radio'; chip.textContent=`R:${r}`;
            wrap.appendChild(chip);
          });
          cell.appendChild(wrap); // time-stack está oculto aquí
        });
      }
      const mo=new MutationObserver(()=>paintChips());
      mo.observe(grid,{childList:true,subtree:true});
      try{
        if(window.firebase && firebase.firestore){
          const TRAMO = (window.TRAMO_ID || new URLSearchParams(location.search).get('tramo') || '1').toString();
          const db=firebase.firestore();
          db.collection('tramos').doc(TRAMO).collection('radios')
            .onSnapshot(snap=>{
              snap.docChanges().forEach(ch=>{
                const id=ch.doc.id, d=(ch.doc.data()||{}), arr=Array.isArray(d.list)?d.list.slice():[];
                if(ch.type==='removed'||arr.length===0) radioClicks.delete(id); else radioClicks.set(id,arr);
              });
              paintChips();
            },err=>console.warn('radio-badges snapshot error:',err));
        }
      }catch(e){ console.warn('radio-badges subscribe error:',e); }
    })();
  </script>
</body>
</html>
