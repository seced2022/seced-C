<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SECeD - Panel Radio</title>
  <link rel="stylesheet" href="styles.css?v=41" />
  <style>
    /* Estilo para el bloqueo de DC */
    .alerta-parada-radio {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(220, 38, 38, 0.98); color: white; z-index: 10000;
      display: flex; flex-direction: column; justify-content: center;
      align-items: center; font-weight: 900; text-align: center;
    }
  </style>
</head>
<body class="radio-skin">
  <main class="app">
    <div class="brand"><img id="mainLogo" src="logo.svg" class="brand-logo" onerror="this.src='logo.png'"/></div>
    <h1 id="mainTitle">SECeD - Panel Radio</h1>
    <div class="clock-bar">
      <div class="clock"><span id="clockTime">--:--:--</span> <span class="sync" id="clockSync">...</span></div>
      <div class="controls-right">
        <div style="display:flex; gap:8px;">
          <button id="btnTramo" class="secondary">TRAMO ▾</button>
          <button id="btnRadio">RADIO: —</button>
        </div>
      </div>
    </div>
    <section id="grid" class="grid"></section>
  </main>

  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>
  
  <script>
    // Variables globales que necesita app.js y nuestra integración
    const db = firebase.firestore();
    const rallyId = new URLSearchParams(window.location.search).get('id');
    const TRAMO_DOC_ID = (new URLSearchParams(location.search).get('tramo') || '1').toString();
    let nombreTramoActual = "";

    // 1. CARGAR CONFIGURACIÓN RALLY
    if (rallyId) {
      db.collection("config_rallies").doc(rallyId).get().then(doc => {
        if (doc.exists) {
          const data = doc.data();
          document.getElementById('mainLogo').src = data.logo;
          document.getElementById('mainTitle').innerText = data.nombre;
          const idx = parseInt(TRAMO_DOC_ID) - 1;
          if (data.tramos && data.tramos[idx]) {
            nombreTramoActual = data.tramos[idx].nombre;
            escucharParadaDC();
          }
        }
      });
    }

    // 2. FUNCIÓN PARA BLOQUEO DE DC (Solo Radio 1)
    function escucharParadaDC() {
      const rIdx = parseInt(localStorage.getItem('seced_radio_id') || '1');
      if (rIdx !== 1) return;

      db.collection("rallies").doc(rallyId).collection("estado_tramos").doc(nombreTramoActual)
        .onSnapshot(doc => {
          let overlay = document.getElementById('overlay-dc');
          if (doc.exists && doc.data().pararSalida) {
            if (!overlay) {
              overlay = document.createElement('div');
              overlay.id = 'overlay-dc';
              overlay.className = 'alerta-parada-radio';
              overlay.innerHTML = `<h1>⚠️ SALIDA PARADA</h1><p>DIRECCIÓN DE CARRERA</p>`;
              document.body.appendChild(overlay);
            }
          } else if (overlay) overlay.remove();
        });
    }

    // 3. ESTA FUNCIÓN LA LLAMARÁ EL APP.JS ORIGINAL AL PICAR
    window.enviarADireccionCarrera = async function(dorsal, radioNum) {
      if (!rallyId || !nombreTramoActual) return;
      try {
        await db.collection("rallies").doc(rallyId).collection("pasos").doc(nombreTramoActual).set({
          [`radio${radioNum}`]: dorsal,
          ultimaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
      } catch (e) { console.error("Error enviando a DC:", e); }
    };
  </script>

  <script src="sync.js?v=16"></script>
  <script src="app.js?v=16"></script>
</body>
</html>
