<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SECeD · Panel Radio</title>
  <style>
    :root{ --bg:#0b1220; --card:#121a2b; --text:#e6eefc; --muted:#9db0d0; --accent:#2563eb; --danger:#dc2626; }
    html,body{ margin:0; height:100%; }
    body.radio-skin{ background:var(--bg); color:var(--text); font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif; }
    .wrap{ max-width:900px; margin:0 auto; padding:16px 16px 88px; }
    h1{ margin:0 0 8px; font-size:20px; font-weight:800; letter-spacing:.3px; }
    .sub{ color:var(--muted); font-size:13px; margin-bottom:18px; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .card{ background:var(--card); border:1px solid #1d2741; border-radius:12px; padding:12px; }
    .pill{ background:#0d1730; border:1px solid #213057; border-radius:999px; padding:8px 12px; color:var(--text); cursor:pointer; user-select:none; font-weight:700; }
    .pill.active{ outline:2px solid var(--accent); background:#0b1f4a; }
    .pill[data-radio-id]{ min-width:48px; text-align:center; }
    .toolbar{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .toolbar .label{ color:var(--muted); font-size:12px; margin-right:4px; }
    .toolbar input{ background:#0d1730; color:var(--text); border:1px solid #1d2741; border-radius:8px; padding:8px 10px; min-width:140px; }
    .toolbar button{ background:#0d1730; color:var(--text); border:1px solid #1d2741; border-radius:8px; padding:8px 12px; cursor:pointer; font-weight:700; }
    .toolbar button:hover{ border-color:#2b3c65; }
    #radioActual{ font-weight:900; }
    /* BOTÓN BANDERA */
    #btnBandera{ position:fixed; right:16px; bottom:16px; z-index:1000; background:var(--danger);
      color:#fff; border:1px solid #b91c1c; border-radius:12px; padding:14px 18px; font-weight:900;
      letter-spacing:.5px; box-shadow:0 12px 28px rgba(0,0,0,.35); cursor:pointer; }
    #btnBandera:active{ transform:translateY(1px); }
    /* TOAST */
    #toast{ position:fixed; left:50%; bottom:20px; transform:translateX(-50%); z-index:1200;
      background:#111827; color:#e5e7eb; border:1px solid #374151; border-radius:10px; padding:10px 14px; display:none; }
    #toast.ok{ border-color:#10b981; color:#ecfdf5; }
    #toast.err{ border-color:#ef4444; color:#fee2e2; }
  </style>

  <!-- Firebase compat SDKs (usa estilo namespace como en tu app) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- Tu config pública (debe definir window.FIREBASE_CONFIG y window.AUDIT_KEY) -->
  <script src="config.js"></script>
</head>
<body class="radio-skin">
  <div class="wrap">
    <h1>Panel Radio</h1>
    <div class="sub">Selecciona tu <b>RADIO</b>, define <b>TRAMO</b> y pulsa <b>BANDERA</b> para enviar un aviso con dorsal.</div>

    <!-- Estado -->
    <div class="card" style="margin-bottom:12px;">
      <div class="row">
        <div><span class="label">TRAMO:</span> <span id="tramoBadge">—</span></div>
        <div>·</div>
        <div><span class="label">RADIO:</span> <span id="radioActual">—</span></div>
        <div>·</div>
        <div><span class="label">OPERADOR:</span> <span id="opBadge">—</span></div>
      </div>
    </div>

    <!-- Selector de radio -->
    <div class="card" style="margin-bottom:12px;">
      <div class="row" id="radioGroup" role="group" aria-label="Seleccionar radio">
        <!-- Botones de ejemplo (modifica la lista si quieres otros radios) -->
        <div class="pill" data-radio-id="1">R1</div>
        <div class="pill" data-radio-id="2">R2</div>
        <div class="pill" data-radio-id="3">R3</div>
        <div class="pill" data-radio-id="4">R4</div>
        <div class="pill" data-radio-id="5">R5</div>
        <div class="pill" data-radio-id="6">R6</div>
        <div class="pill" data-radio-id="7">R7</div>
        <div class="pill" data-radio-id="8">R8</div>
        <div class="pill" data-radio-id="9">R9</div>
        <div class="pill" data-radio-id="10">R10</div>
      </div>
    </div>

    <!-- Herramientas -->
    <div class="card toolbar">
      <div class="row">
        <span class="label">Cambiar TRAMO:</span>
        <input id="tramoInput" type="text" placeholder="p.ej. 1" />
        <button id="tramoGo" type="button">Aplicar</button>
      </div>
      <div class="row">
        <button id="btnOperador" type="button">Definir operador…</button>
      </div>
    </div>
  </div>

  <!-- Botón flotante BANDERA -->
  <button id="btnBandera" type="button" aria-label="Enviar AVISO de radio">BANDERA</button>

  <!-- Toast -->
  <div id="toast"></div>

  <script>
    // ---------- Helpers UI ----------
    const $ = (sel) => document.querySelector(sel);
    const tramoBadge = $('#tramoBadge');
    const radioActual = $('#radioActual');
    const opBadge = $('#opBadge');
    const tramoInput = $('#tramoInput');
    const tramoGo = $('#tramoGo');
    const btnOperador = $('#btnOperador');
    const btnBandera = $('#btnBandera');
    const toastEl = $('#toast');

    function toast(msg, kind){ // kind: 'ok' | 'err' | undefined
      toastEl.textContent = msg || '';
      toastEl.className = '';
      toastEl.classList.add(kind === 'ok' ? 'ok' : (kind === 'err' ? 'err' : ''));
      toastEl.style.display = 'block';
      clearTimeout(toastEl._t);
      toastEl._t = setTimeout(()=>{ toastEl.style.display = 'none'; }, 2400);
    }

    // ---------- Estado global ----------
    window.TRAMO_ID = (new URLSearchParams(location.search).get('tramo') || '1').toString();
    tramoBadge.textContent = window.TRAMO_ID;

    function getOperator(){ try { return localStorage.getItem('seced_operator') || ''; } catch { return ''; } }
    function setOperator(name){ try { localStorage.setItem('seced_operator', name || ''); } catch {} updateBadges(); }
    window.OPERATOR = getOperator();
    function updateBadges(){
      tramoBadge.textContent = (window.TRAMO_ID || '—');
      opBadge.textContent = (window.OPERATOR || '—') || '—';
      radioActual.textContent = (getRadioId() || '—');
    }
    updateBadges();

    if (btnOperador) btnOperador.addEventListener('click', ()=>{
      const name = prompt('Nombre o identificador del operador:', window.OPERATOR||'');
      if (name !== null) { window.OPERATOR = (name||'').trim(); setOperator(window.OPERATOR); }
    });

    if (tramoGo) tramoGo.addEventListener('click', ()=>{
      const t = (tramoInput.value || '').trim();
      if (!t) return;
      window.TRAMO_ID = t;
      const p = new URLSearchParams(location.search);
      p.set('tramo', t);
      history.replaceState(null, '', location.pathname + '?' + p.toString());
      updateBadges();
      toast('Tramo aplicado', 'ok');
    });

    // ---------- Firebase init ----------
    (function initFirebase(){
      try{
        if (!window.firebase?.apps?.length) firebase.initializeApp(window.FIREBASE_CONFIG);
        window._db = firebase.firestore();
      }catch(e){
        console.error('Firebase init error', e);
        toast('Firebase no inicializado', 'err');
      }
    })();

    // ---------- Selección de Radio ----------
    function storeRadio(id){
      if (!id) return;
      window.RADIO_ID = String(id).trim();
      try { localStorage.setItem('seced_radio_id', window.RADIO_ID); } catch {}
      // compat antiguo
      try { localStorage.setItem('seced_radio', window.RADIO_ID); } catch {}
      // UI
      document.querySelectorAll('[data-radio-id]').forEach(el=>{
        el.classList.toggle('active', el.getAttribute('data-radio-id') === window.RADIO_ID);
      });
      updateBadges();
    }

    function getRadioId(){
      try{
        const checked = document.querySelector('[name="radio"]:checked');
        if (checked?.value) return String(checked.value).trim();

        const activeBtn = document.querySelector('.radio-option.active,[data-radio-selected="true"], .pill.active');
        if (activeBtn) {
          const v = activeBtn.getAttribute('data-radio-id') || activeBtn.getAttribute('data-radio') || activeBtn.textContent;
          if (v) return String(v).trim();
        }

        const byIdText = document.getElementById('radioActual');
        if (byIdText && byIdText.textContent) return String(byIdText.textContent).trim();

        const bodyAttr = document.body.getAttribute('data-radio');
        if (bodyAttr) return String(bodyAttr).trim();

        if (window.RADIO_ID) return String(window.RADIO_ID).trim();

        const qp = new URLSearchParams(location.search).get('radio');
        if (qp) return String(qp).trim();

        const v2 = (localStorage.getItem('seced_radio_id') || '').trim(); if (v2) return v2;
        const v1 = (localStorage.getItem('seced_radio') || '').trim(); if (v1) return v1;
      }catch{}
      return '';
    }

    // activar click para los botones predefinidos
    document.querySelectorAll('[data-radio-id]').forEach(el=>{
      el.addEventListener('click', ()=>{
        storeRadio(el.getAttribute('data-radio-id'));
      });
    });

    // Inicial: usa query/localStorage si existe
    (function initRadioFromState(){
      const initial = getRadioId();
      if (initial) storeRadio(initial);
    })();

    // ---------- Auditoría opcional (no rompe si no existe) ----------
    function logAudit(action, detail){
      try{
        const db = window._db;
        if (!db) return;
        const tramo = (window.TRAMO_ID || '1').toString();
        db.collection('tramos').doc(tramo).collection('audit').add({
          ts: firebase.firestore.FieldValue.serverTimestamp(),
          clientTime: new Date().toISOString(),
          actor: (window.OPERATOR || '—'),
          action, detail: detail || {}
        }).catch(()=>{});
      }catch(e){}
    }

    // ---------- Publicar AVISO (radio + dorsal) ----------
    async function publishRadioAlert(dorsal) {
      try {
        const radio = getRadioId();
        if (!radio) { alert('No se ha detectado el número de RADIO seleccionado.\nSelecciona un radio e inténtalo de nuevo.'); return; }
        if (!Number.isFinite(dorsal)) { alert('Dorsal inválido.'); return; }
        const db = window._db;
        if (!db) { alert('Firestore no está disponible en esta página.'); return; }

        const tramo = (window.TRAMO_ID || new URLSearchParams(location.search).get('tramo') || '1').toString();
        const payload = {
          tramo,
          radio: String(radio),
          dorsal: Number(dorsal),
          actor: (window.OPERATOR || '—'),
          type: 'radio_alert',
          clientTs: Date.now(),
          ts: firebase.firestore.FieldValue.serverTimestamp()
        };

        await db.collection('tramos').doc(tramo).collection('alerts').add(payload);
        try { logAudit('radio_alert_emit', { radio, dorsal }); } catch {}
        toast(`Aviso enviado: R${radio} · D${dorsal}`, 'ok');
      } catch (e) {
        console.error('publishRadioAlert error', e);
        alert('Error enviando AVISO. Revisa conexión y Firestore/Reglas.');
        toast('No enviado', 'err');
      }
    }

    // ---------- Botón BANDERA ----------
    function wireBandera(btn){
      btn.onclick = (ev)=>{
        ev.preventDefault();
        const raw = prompt('Dorsal a avisar:');
        if (raw === null) return;
        const dorsal = Number((raw || '').trim());
        if (!Number.isFinite(dorsal)) { alert('Introduce un dorsal válido (número).'); return; }
        publishRadioAlert(dorsal);
      };
      btn.setAttribute('aria-label', 'Enviar AVISO de radio');
    }
    wireBandera(btnBandera);
  </script>
</body>
</html>
